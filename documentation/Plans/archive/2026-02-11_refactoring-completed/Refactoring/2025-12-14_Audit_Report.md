# Отчет об аудите проекта ArcadeQuiz
2025-12-14

## 1. Общее состояние проекта
Проект использует современный стек (Phaser 3 + React + Vite). Структура папок логична и следует модульному принципу. Однако с ростом функционала накопился технический долг, особенно в части типизации и разделения ответственности классов.

**Ключевые показатели:**
- **Типизация:** Частичная. Критичное количество `any` в ключевых системах.
- **Архитектура:** Присутствуют анти-паттерны (God Class `MainScene`).
- **Тесты:** Покрытие есть, но уверенность снижена из-за использования `any` в моках.

---

## 2. Критические проблемы (High Priority)

### 2.1. Потеря типобезопасности в CollisionSystem
**Файл:** `src/game/systems/CollisionSystem.ts`
**Проблема:** Использование `any` в колбэках коллизий:
```typescript
(player: any, enemy: any) => { ... } // Line 66
```
Это полностью убивает смысл TypeScript в физике, так как нет автодополнения и проверки свойств (например, `enemy.getData('enemy')`).
**Риск:** Высокая вероятность ошибок при изменении свойств сущностей (Runtime Error).
**Рекомендация:**
1. Определить строгие типы для аргументов (использовать `Phaser.Types.Physics.Arcade.GameObjectWithBody`).
2. Использовать Type Guards для проверки типов (`isPlayer`, `isEnemy`).

### 2.2. Перегруженный класс MainScene (God Class)
**Файл:** `src/game/scenes/MainScene.ts`
**Проблема:** Класс содержит **4400+ строк**. Он занимается всем:
- Инициализация мира
- Спавн объектов
- Обработка ввода
- Управление UI (модальные окна)
- Логика игры (очки, здоровье)
**Риск:** Сложность поддержки, высокий риск регрессий при любых изменениях.
**Рекомендация:**
1. Вынести логику создания мира (Tiled Map) в отдельный сервис `WorldBuilder`.
2. Вынести управление UI в `UIManager` (частично сделано, но MainScene все еще управляет модалками напрямую).
3. Перенести логику очков/здоровья в соответствующие системы (уже есть, но MainScene дублирует управление).

### 2.3. Смешение старой и новой систем спавна
**Файл:** `src/game/systems/SpawnSystem.ts`
**Проблема:** В одном файле живут старая логика (круги/зоны) и новая (матричная система). Много кода помечено комментариями, но не удалено.
**Риск:** Путаница при использовании. Возможность вызова deprecated методов.
**Рекомендация:**
1. Удалить deprecated методы (`addOccupiedZone`).
2. Рефакторинг: оставить только матричную систему как единственный источник правды.

---

## 3. Архитектурные риски (Medium Priority)

### 3.1. "Магические числа" и Хардкод
В `CollisionSystem.ts` и `MainScene.ts` встречаются хардкодные значения:
- `dist < 30` (проверка входа в портал).
- Урон (1) по дефолту.
**Рекомендация:** Вынести все константы в `src/constants/gameConstants.ts` или конфиги уровня.
*(Частично выполнено: настройки коллизий Tiled Map вынесены в `COLLISION_CONFIG`)*

### 3.2. React Integration
**Файл:** `src/react/PhaserGame.tsx`
Интеграция выглядит надежной (React 18 friendly), но содержит много логики по ресайзу внутри компонента.
**Рекомендация:** Вынести логику `getGameSize` и обработчики resize в хук `useGameResize` или утилиту.

### 3.3. Тестирование
В тестах часто встречается `let mockScene: any;`. Это скрывает ошибки интерфейса сцены.
**Рекомендация:** Создать типизированный Mock для сцены (`MockScene implements Phaser.Scene`), реализующий только нужные методы.

---

## 4. План рефакторинга (Roadmap)

### Этап 1: Типизация и Стабилизация (Срочно) - [COMPLETED]
1. [x] **CollisionSystem:** Заменить `any` на реальные типы Phaser.
2. [x] **Constants:** Вынести магические числа (дистанция активации портала, тайминги) в константы.
3. [x] **SpawnSystem:** Очистка от legacy-кода.

### Этап 2: Декомпозиция MainScene (Важно) - [COMPLETED]
1. [x] Создать `WorldGenerator` для выноса логики `createGameWorldTiled`.
2. [x] Завершить изоляцию UI: полностью перенести управление модалками в `UIManager`.
3. [x] Убрать прямую зависимость MainScene от модальных окон (использовать события/сигналы).

### Этап 3: Оптимизация - [COMPLETED]
1. [x] Улучшение моков в тестах (modal-scaling.test.ts updated).
2. [x] Вынос UI-логики из React-компонента игры (DeviceUtils extracted).

---

**Готов приступить к Этапу 1 по команде пользователя.**

---

## 5. Выполненные работы (Completed)

### 2025-12-14: Улучшение системы коллизий (Tiled Map)
- **Problem:** Конфликт между "твердыми" стенами и триггерами взаимодействия в Tiled Map режиме.
- **Solution:** Реализована "воксельная" генерация коллизий с учетом Overlap Mask.
- **Improvement:** Внедрена механика "Sensor Bodies" (расширение тела на 2px) для гарантированного срабатывания интеракции при контакте со стеной.
- **Refactoring:** Значение расширения вынесено в `COLLISION_CONFIG.TILED_SENSOR_EXPANSION`.

### 2025-12-14: Этап 1 - Типизация и Стабилизация
- **CollisionSystem:** Внедрен `typeGuards.ts`, удалены `any` в колбэках.
- **SpawnSystem:** Полный переход на матричную систему, удален legacy код.
- **Constants:** Вынесены настройки взаимодействий (`INTERACTION_CONFIG`).
- **QA:** Пройдены тесты SpawnSystem и static analysis.

### 2025-12-14: Этап 2 - Декомпозиция MainScene
- **WorldGenerator:** Логика генерации карты из Tiled Map вынесена в `WorldGenerator.ts`.
- **UIManager:** Создан централизованный менеджер модальных окон. `MainScene` теперь управляет UI через события (`EVENTS`).
- **Bug Fixes:** Исправлена инициализация меток Оракула и коллизия активированных порталов (авто-отключение вокселей).
- **Status:** Архитектура сцены упрощена, прямые зависимости удалены.

### 2025-12-14: Этап 3 - Оптимизация
- **Integration Tests:** Восстановлена работоспособность `modal-scaling.test.ts`. Обновлены моки сцены для динамического расчета размеров текста.
- **Utils:** Исправлена логика `FontSizeCalculator` (корректное ограничение макс. размера). Исправлена константа `MIN_FONT_SIZE_BUTTON`.
- **React:** Рефакторинг `PhaserGame.tsx`. Логика расчета размеров экрана вынесена в `DeviceUtils`.
- **Status:** Проект стабилизирован. Все тесты проходят.
