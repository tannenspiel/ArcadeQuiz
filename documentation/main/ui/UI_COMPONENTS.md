# UI Components Documentation

**Файл:** `UI_COMPONENTS.md`  
**Версия:** 1.0  
**Дата:** 2026-01-28  
**Статус:** Актуально

---

## Введение

Этот документ описывает архитектуру и реализацию UI компонентов проекта ArcadeQuiz, включая систему кнопок, модальные окна и специальные визуальные эффекты.

---

## 1. Button System (Кнопки)

**Файл:** `src/game/ui/Button.ts`

Класс `Button` является универсальным компонентом для всех интерактивных элементов UI. Он поддерживает различные состояния, стили рендеринга и анимации.

### Архитектура

Кнопка состоит из следующих слоев (по порядку отрисовки, от нижнего к верхнему):
1.  **Background (Фон):**
    *   Либо `Phaser.GameObjects.Rectangle` (простой цветной прямоугольник).
    *   Либо `NineSliceBackground` (текстурированный 9-slice контейнер).
2.  **Glow Overlay (Свечение - опционально):**
    *   `Phaser.GameObjects.Graphics` (желтый прямоугольник с режимом наложения `ADD`).
    *   Используется только в состоянии `BLINKING`.
3.  **Text (Текст):**
    *   `Phaser.GameObjects.Text`.
4.  **Feedback Text (Обратная связь - опционально):**
    *   Текст под кнопкой (устаревший функционал, теперь фидбек часто внутри кнопки).

### Состояния (ButtonState)

| Состояние | Описание | Визуализация |
| :--- | :--- | :--- |
| `NORMAL` | Обычное состояние | Базовый цвет / Белый тинт для 9-slice |
| `HOVER` | Наведение мыши (Desktop) | Осветление |
| `ACTIVE` | Нажатие | Затемнение / Зеленый |
| `DISABLED`| Отключена | Темно-серый, не кликабельна |
| `BLINKING`| Мигание (подсказка) | **Особый режим:** База NORMAL + Пульсирующее золотое свечение |
| `WRONG` | Ошибка | Красный цвет |
| `CORRECT` | Правильный ответ | Ярко-зеленый цвет |

### Механика Мигания (Blinking)

Реализация эффекта мигания (золотая пульсация) прошла через несколько итераций.

**Текущая реализация (Working Solution):**
*   **Технология:** `Phaser.GameObjects.Graphics`.
*   **Метод:** `createGlowBackground()`.
*   **Логика:**
    1.  Создается графический примитив (прямоугольник) точного размера кнопки.
    2.  Заливка цветом `0xffaa00` (Золотой).
    3.  Режим наложения `Phaser.BlendModes.ADD`.
    4.  Позиционирование строго по центру кнопки (`x - w/2`, `y - h/2`).
    5.  Анимация `alpha` (прозрачности) от 0 до 0.8.
*   **Почему так:** Режим `ADD` поверх обычной кнопки создает эффект свечения. Использование `Graphics` гарантирует корректный рендеринг режима наложения.

**Отброшенные варианты (Failed Attempts):**
*   *Tint Tween:* Использование `setTint` на самой кнопке приводило к затемнению (умножение цвета), а не высветлению.
*   *Cloned Overlay (NineSlice):* Попытка создать точную копию 9-slice кнопки и наложить её сверху с режимом `ADD` оказалась неудачной. Вероятно, из-за специфики рендеринга вложенных контейнеров Phaser, эффект был либо невидимым, либо некорректным.

---

## 2. NineSliceBackground

**Файл:** `src/game/ui/NineSliceBackground.ts`

Кастомная реализация 9-slice (растягиваемого) фона, так как встроенный `nineslice` в Phaser 3 имеет ограничения.

*   Тип: `Phaser.GameObjects.Container`.
*   Структура: 9 отдельных `Image` или `TileSprite` (углы, стороны, центр).
*   **Особенность:** Так как это `Container`, методы типа `setAlpha`, `setTint` и `setBlendMode` реализованы вручную через итерацию детей (`this.each(...)`).

---

## 3. KeyQuestionModal (Модальное окно Ключа)

**Файл:** `src/game/ui/KeyQuestionModal.ts`

Окно, отображающее вопрос при подборе ключа.

### Логика Взаимодействия (Double Click Logic)

Для предотвращения случайных ошибочных нажатий или "прокликивания", реализована логика для **правильного ответа**:

1.  **Первое нажатие на правильный ответ:**
    *   Кнопка переходит в состояние `CORRECT` (Зеленая).
    *   Появляется текст "Нажмите еще раз для подтверждения".
    *   Остальные кнопки блокируются (но не скрываются).
2.  **Второе нажатие на ТУ ЖЕ кнопку:**
    *   Ответ засчитывается.
    *   Запускается анимация победы / закрытия.
3.  **Нажатие на другую кнопку (если бы было возможно):**
    *   Сброс выделения (в текущей реализации остальные блокируются).

**Неправильный ответ:**
*   Срабатывает сразу (без подтверждения).
*   Кнопка становится `WRONG` (Красная).
*   Показывается правильный ответ (мигает кнопка с правильным ответом).
*   Через задержку окно закрывается.

---

- **UIManager** → `src/game/ui/UIManager.ts`
  - Гарантирует, что открыто только одно окно.
  - Управляет паузой сцены (`scene.pause()` / `resume()`).
  - Обрабатывает `resize` событий экрана.

---

## CoinBubbleQuiz

`CoinBubbleQuiz` — это легкий UI-компонент, используемый в фазе `COIN` для подтверждения подбора монеты.

### Особенности
- **Screen Space:** Располагается поверх игры, но не блокирует весь ввод (в отличие от модальных окон).
- **Без подложки:** Не имеет затемняющего фона, что сохраняет динамику игры.
- **Два баббла:** Левый баббл отображает утверждение, правый — кнопки выбора ("ДА" / "НЕТ").
- **Адаптивность:** Автоматически подстраивается под размер экрана и зум камеры.

### Взаимодействие
- Вызывается при коллизии игрока с монетой.
- Использует событие `SHOW_COIN_QUIZ` через EventBus.
- Возвращает результат через callback (правильно/неправильно).

---

## 4. Hybrid Loading Screen (Экран Загрузки)

**Файлы:** `src/game/scenes/LoadingScene.ts`, `index.html`

Система загрузки использует гибридный подход для минимизации FCP и создания ощущения мгновенного запуска.

### Компоненты
1.  **DOM Overlay (`#loading-overlay`):**
    *   Статический HTML/CSS элемент в `index.html`.
    *   Появляется мгновенно (вместе с загрузкой страницы).
    *   Содержит: логотип, спиннер `div.spinner` (CSS keyframes), текстовые поля `.loading-text` и `.progress-text`.
    *   **Z-Index:** 9999 (перекрывает Canvas).

2.  **Phaser Integration (`LoadingScene`):**
    *   Сцена запускается *после* инициализации движка.
    *   Находит DOM-элементы через `document.getElementById`.
    *   Обновляет текст `.progress-text` процентами загрузки (0-100%).
    *   Управляет видимостью:
        *   `setVisible(true)` при старте.
        *   `opacity: 0` + `setTimeout` при завершении.

### Логика исчезновения
Чтобы избежать "скачков" (когда DOM исчезает раньше, чем игра отрисует первый кадр):
1.  `.progress-text` показывает "Готово!".
2.  `LoadingScene` запускает таймер (300ms).
3.  Через 300ms DOM-элемент удаляется из дерева.
4.  Включены `try-catch` блоки для защиты от ошибок, если элемент уже удален.

---
