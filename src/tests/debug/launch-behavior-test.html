<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>scene.launch() Behaviour Test</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a202c;
            font-family: monospace;
        }
        #game-container {
            width: 800px;
            height: 600px;
            margin: 20px auto;
        }
        #info {
            color: #e5e7eb;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #2d3748;
        }
        .test {
            margin: 10px 0;
            padding: 10px;
            border-left: 3px solid #4ade80;
        }
    </style>
</head>
<body>
    <div id="info">
        <h1>üß™ scene.launch() Behaviour Test</h1>

        <div class="test">
            <strong>Test 1: Input</strong>
            <br>–ù–∞–∂–º–∏—Ç–µ —Å—Ç—Ä–µ–ª–∫–∏ –Ω–∞ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ. –ö–∞–∫–∞—è —Å—Ü–µ–Ω–∞ –ø–æ–ª—É—á–∏—Ç input?
            <br>–û–∂–∏–¥–∞–Ω–∏–µ: MainScene (–ø–æ—Å–ª–µ–¥–Ω—è—è –∑–∞–ø—É—â–µ–Ω–Ω–∞—è)
        </div>

        <div class="test">
            <strong>Test 2: Async create()</strong>
            <br>–°–º–æ—Ç—Ä–∏—Ç–µ –≤ –∫–æ–Ω—Å–æ–ª—å: –∫–æ–≥–¥–∞ –Ω–∞—á–Ω—ë—Ç—Å—è MainScene.update()?
            <br>–û–∂–∏–¥–∞–Ω–∏–µ: –ù–ï —Ä–∞–Ω—å—à–µ —á–µ–º create() –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è
        </div>

        <div class="test">
            <strong>Test 3: Double update()</strong>
            <br>–°–∫–æ–ª—å–∫–æ —Å—Ü–µ–Ω –ø–æ–ª—É—á–∞–µ—Ç update() –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ?
            <br>–û–∂–∏–¥–∞–Ω–∏–µ: –û–±–µ —Å—Ü–µ–Ω—ã –ø–æ–ª—É—á–∞—é—Ç update()
        </div>

        <div class="test">
            <strong>Test 4: Scene order</strong>
            <br>–í –∫–∞–∫–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Å—Ü–µ–Ω—ã —Å–æ–∑–¥–∞—é—Ç—Å—è?
            <br>–û–∂–∏–¥–∞–Ω–∏–µ: TestLoadingScene ‚Üí TestMainScene
        </div>

        <p style="color: #fbbf24;">
            üí° –û—Ç–∫—Ä–æ–π—Ç–µ DevTools Console –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤
        </p>
    </div>

    <div id="game-container"></div>

    <!-- Import Phaser as UMD -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.90.0/dist/phaser.min.js"></script>

    <!-- Test script -->
    <script>
        // ============================================
        // TestScene 1 ‚Äî LoadingScene prototype
        // ============================================
        class TestLoadingScene extends Phaser.Scene {
            constructor() {
                super({ key: 'TestLoadingScene' });
            }

            preload() {
                console.log('üîµ TestLoadingScene: preload()');

                // –ò–º–∏—Ç–∞—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞—Å—Å–µ—Ç–æ–≤
                this.load.on('progress', (p) => {
                    console.log(`üîµ Loading progress: ${Math.round(p * 100)}%`);
                });

                this.load.once('complete', () => {
                    console.log('üîµ TestLoadingScene: Assets loaded, launching TestMainScene...');

                    setTimeout(() => {
                        this.scene.launch('TestMainScene');
                        console.log('üîµ TestLoadingScene: after launch()');
                        console.log('üîµ Active scenes:', this.scene.manager.getActiveScenes().map(s => s.sceneKey));
                    }, 500);
                });

                // –°–æ–∑–¥–∞—ë–º —Ç–µ–∫—Å—Ç—É—Ä—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
                const graphics = this.make.graphics();
                graphics.fillStyle(0x00ff00);
                graphics.fillRect(0, 0, 100, 100);
                graphics.generateTexture('test1', 100, 100);

                this.load.image('test1', 'test1');
                this.load.start();
            }

            create() {
                console.log('üîµ TestLoadingScene: create()');

                this.add.text(100, 50, 'Loading Scene', { fontSize: '24px', color: '#00ff00' });
                const progressText = this.add.text(100, 80, 'Progress: 0%', { fontSize: '18px', color: '#ffffff' });
                this.progressText = progressText;
            }

            update(time, delta) {
                if (!this.updateCount) this.updateCount = 0;
                this.updateCount++;

                if (this.updateCount <= 5) {
                    console.log(`üîµ TestLoadingScene: update() #${this.updateCount}`);
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º input
                const keys = this.input.keyboard.createCursorKeys();
                if (keys.left.isDown || keys.right.isDown || keys.up.isDown || keys.down.isDown) {
                    if (!this.inputDetected) {
                        console.log(`üîµ TestLoadingScene: INPUT DETECTED at frame ${this.updateCount}!`);
                        this.inputDetected = true;
                    }
                }
            }

            setProgress(percent, text) {
                console.log(`üîµ TestLoadingScene: setProgress(${percent}%, ${text})`);
                if (this.progressText) {
                    this.progressText.setText(`${text}: ${percent}%`);
                }
            }
        }

        // ============================================
        // TestScene 2 ‚Äî MainScene prototype
        // ============================================
        class TestMainScene extends Phaser.Scene {
            constructor() {
                super({ key: 'TestMainScene' });
            }

            async create() {
                console.log('üü¢ TestMainScene: create() START');

                this.add.text(100, 150, 'Main Scene', { fontSize: '24px', color: '#ff0000' });
                const statusText = this.add.text(100, 180, 'Initializing...', { fontSize: '18px', color: '#ffffff' });
                this.statusText = statusText;

                console.log('üü¢ TestMainScene: Before delay (2000ms)');
                console.log('üü¢ TestMainScene: update() should NOT be called yet');

                // –ò–º–∏—Ç–∞—Ü–∏—è async –æ–ø–µ—Ä–∞—Ü–∏–π
                await this.delay(1000);
                console.log('üü¢ TestMainScene: After delay 1 (1000ms)');

                await this.delay(1000);
                console.log('üü¢ TestMainScene: After delay 2 (1000ms)');

                statusText.setText('Ready!');
                this.isReady = true;

                console.log('üü¢ TestMainScene: create() END, isReady=${this.isReady}');
                console.log('üü¢ TestMainScene: Active scenes:', this.scene.manager.getActiveScenes().map(s => s.sceneKey));

                // –û–±–Ω–æ–≤–ª—è–µ–º LoadingScene
                const loadingScene = this.scene.get('TestLoadingScene');
                if (loadingScene && loadingScene.setProgress) {
                    loadingScene.setProgress(100, 'Ready');

                    setTimeout(() => {
                        this.scene.stop('TestLoadingScene');
                        console.log('üü¢ TestMainScene: LoadingScene stopped');
                        console.log('üü¢ TestMainScene: Active scenes after stop:', this.scene.manager.getActiveScenes().map(s => s.sceneKey));
                    }, 500);
                }
            }

            update(time, delta) {
                if (!this.updateCount) this.updateCount = 0;
                this.updateCount++;

                if (this.updateCount <= 10) {
                    console.log(`üü¢ TestMainScene: update() #${this.updateCount}, isReady=${this.isReady}`);
                }

                // ‚úÖ –ù–ï –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º input –ø–æ–∫–∞ –Ω–µ –≥–æ—Ç–æ–≤—ã
                if (!this.isReady) {
                    return;
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º input
                const keys = this.input.keyboard.createCursorKeys();
                if (keys.left.isDown || keys.right.isDown || keys.up.isDown || keys.down.isDown) {
                    if (!this.inputDetected) {
                        console.log(`üü¢ TestMainScene: INPUT DETECTED at frame ${this.updateCount}!`);
                        this.inputDetected = true;
                    }
                }
            }

            delay(ms) {
                return new Promise(resolve => {
                    this.time.delayedCall(ms, resolve);
                });
            }
        }

        // ============================================
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–≥—Ä—ã
        // ============================================
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game-container',
            backgroundColor: '#1a202c',
            scene: [TestLoadingScene, TestMainScene],
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { x: 0, y: 0 }
                }
            }
        };

        // ============================================
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        // ============================================
        console.log('üéÆ Starting game...');
        const game = new Phaser.Game(config);
    </script>
</body>
</html>
