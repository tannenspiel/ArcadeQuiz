<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EventBus & Timing Test</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #1a202c;
            font-family: monospace;
        }
        #game-container {
            width: 800px;
            height: 600px;
            margin: 20px auto;
        }
        #info {
            color: #e5e7eb;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background: #2d3748;
        }
        .test {
            margin: 10px 0;
            padding: 10px;
            border-left: 3px solid #4ade80;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            border-left: 3px solid #fbbf24;
        }
        pre {
            background: #1a202c;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div id="info">
        <h1>üß™ EventBus & Timing Test</h1>

        <div class="test">
            <strong>Test 1: this.events –º–µ–∂–¥—É —Å—Ü–µ–Ω–∞–º–∏</strong>
            <br>LoadingScene –ø–æ–¥–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ, MainScene emit.
            <br>–û–∂–∏–¥–∞–Ω–∏–µ: –†–∞–±–æ—Ç–∞–µ—Ç
        </div>

        <div class="test">
            <strong>Test 2: –ì–ª–æ–±–∞–ª—å–Ω—ã–π EventBus (EventBus.ts)</strong>
            <br>–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥–ª–æ–±–∞–ª—å–Ω—ã–π EventBus –≤–º–µ—Å—Ç–æ this.events
            <br>–û–∂–∏–¥–∞–Ω–∏–µ: –†–∞–±–æ—Ç–∞–µ—Ç
        </div>

        <div class="test">
            <strong>Test 3: pause() –¥–ª—è LoadingScene</strong>
            <br>–ú–æ–∂–Ω–æ –ª–∏ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å LoadingScene.update()?
            <br>–û–∂–∏–¥–∞–Ω–∏–µ: pause() —Ä–∞–±–æ—Ç–∞–µ—Ç, setProgress() –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç
        </div>

        <div class="test">
            <strong>Test 4: Timing finishLoading()</strong>
            <br>–ö–æ–≥–¥–∞ –∏–º–µ–Ω–Ω–æ —É–Ω–∏—á—Ç–æ–∂–∞—Ç—å LoadingScene?
            <br>–û–∂–∏–¥–∞–Ω–∏–µ: –ü–æ—Å–ª–µ –ø–µ—Ä–≤–æ–≥–æ frame MainScene
        </div>

        <div id="results"></div>

        <p style="color: #fbbf24;">
            üí° –û—Ç–∫—Ä–æ–π—Ç–µ DevTools Console –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ª–æ–≥–æ–≤
        </p>
    </div>

    <div id="game-container"></div>

    <!-- Import Phaser -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.90.0/dist/phaser.min.js"></script>

    <!-- Test script -->
    <script>
        // ============================================
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π EventBus (–ø—Ä–æ—Å—Ç–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è)
        // ============================================
        class GlobalEventBus {
            constructor() {
                this.listeners = {};
            }

            on(event, callback) {
                if (!this.listeners[event]) {
                    this.listeners[event] = [];
                }
                this.listeners[event].push(callback);
                console.log(`üì° EventBus: Subscribed to "${event}"`);
            }

            emit(event, data) {
                console.log(`üì° EventBus: Emitting "${event}"`, data);
                if (this.listeners[event]) {
                    this.listeners[event].forEach(cb => cb(data));
                }
            }

            off(event, callback) {
                if (this.listeners[event]) {
                    this.listeners[event] = this.listeners[event].filter(cb => cb !== callback);
                }
            }
        }

        const EventBus = new GlobalEventBus();
        window.__EventBus = EventBus;  // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏

        // ============================================
        // TestLoadingScene
        // ============================================
        class TestLoadingScene extends Phaser.Scene {
            constructor() {
                super({ key: 'TestLoadingScene' });
            }

            preload() {
                console.log('üîµ TestLoadingScene: preload()');

                this.load.on('progress', (p) => {
                    const progress = Math.round(p * 50); // 0-50%
                    console.log(`üîµ LoadingScene: Assets progress ${progress}%`);
                    EventBus.emit('loading-progress', {
                        percent: progress,
                        text: `–ó–∞–≥—Ä—É–∑–∫–∞ –∞—Å—Å–µ—Ç–æ–≤... ${progress}%`
                    });
                });

                this.load.once('complete', async () => {
                    console.log('üîµ TestLoadingScene: Assets loaded');

                    // –ò–º–∏—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç—ã
                    await new Promise(r => this.time.delayedCall(500, r));

                    // Test 3: pause() vs setProgress()
                    console.log('üîµ TestLoadingScene: Launching MainScene...');
                    this.scene.launch('TestMainScene');

                    // Test 3A: –ü—Ä–æ–±—É–µ–º pause()
                    // this.scene.pause('TestLoadingScene');
                    console.log('üîµ TestLoadingScene: Active scenes:',
                        this.scene.manager.scenes.map(s => s.sceneKey));
                });

                // –°–æ–∑–¥–∞—ë–º —Ç–µ–∫—Å—Ç—É—Ä—É –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
                const graphics = this.make.graphics();
                graphics.fillStyle(0x00ff00);
                graphics.fillRect(0, 0, 100, 100);
                graphics.generateTexture('test1', 100, 100);
                this.load.image('test1', 'test1');
                this.load.start();
            }

            create() {
                console.log('üîµ TestLoadingScene: create()');

                // UI
                this.add.text(100, 50, 'Loading Scene', { fontSize: '24px', color: '#00ff00' });
                this.progressText = this.add.text(100, 80, 'Progress: 0%', { fontSize: '18px', color: '#ffffff' });
                this.statusText = this.add.text(100, 110, 'Status: Loading assets...', { fontSize: '16px', color: '#cccccc' });

                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–π EventBus
                EventBus.on('loading-progress', (data) => {
                    console.log(`üîµ TestLoadingScene: Received progress event`, data);
                    this.setProgress(data.percent, data.text);
                });

                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ pause/resume
                EventBus.on('pause-loading', () => {
                    console.log('üîµ TestLoadingScene: Paused (update –Ω–µ –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è)');
                    this.scene.pause();
                });

                EventBus.on('resume-loading', () => {
                    console.log('üîµ TestLoadingScene: Resumed (update –±—É–¥–µ—Ç –≤—ã–∑—ã–≤–∞—Ç—å—Å—è)');
                    this.scene.resume();
                });
            }

            setProgress(percent, text) {
                console.log(`üîµ TestLoadingScene: setProgress(${percent}%, ${text})`);
                if (this.progressText) {
                    this.progressText.setText(`Progress: ${percent}%`);
                }
                if (this.statusText) {
                    this.statusText.setText(`Status: ${text}`);
                }
            }

            update(time, delta) {
                // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è —Ç–µ—Å—Ç–∞ pause()
                if (!this.updateCount) this.updateCount = 0;
                this.updateCount++;

                if (this.updateCount <= 3) {
                    console.log(`üîµ TestLoadingScene: update() #${this.updateCount}`);
                }
            }
        }

        // ============================================
        // TestMainScene
        // ============================================
        class TestMainScene extends Phaser.Scene {
            constructor() {
                super({ key: 'TestMainScene' });
                this.isReady = false;
            }

            async create() {
                console.log('üü¢ TestMainScene: create() START');

                // UI
                this.add.text(100, 200, 'Main Scene', { fontSize: '24px', color: '#ff0000' });
                this.statusText = this.add.text(100, 230, 'Initializing...', { fontSize: '18px', color: '#ffffff' });

                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã–π EventBus
                EventBus.on('loading-progress', (data) => {
                    console.log(`üü¢ TestMainScene: Received progress event`, data);
                    // MainScene —Ç–æ–∂–µ –º–æ–∂–µ—Ç –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å (–¥–ª—è —Ç–µ—Å—Ç–∞)
                    this.statusText.setText(`Main sees: ${data.percent}% - ${data.text}`);
                });

                // ========================================
                // Test 1: this.events –º–µ–∂–¥—É —Å—Ü–µ–Ω–∞–º–∏
                // ========================================
                console.log('--- Test 1: this.events ---');

                // –ü—Ä–æ–±—É–µ–º –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–æ–±—ã—Ç–∏–µ MainScene
                this.events.on('test-event', (data) => {
                    console.log('üü¢ TestMainScene: Received test-event', data);
                });

                // Emit –Ω–∞ —Å–∞–º–æ–≥–æ —Å–µ–±—è
                this.events.emit('test-event', { from: 'MainScene', data: 'test' });
                console.log('üü¢ TestMainScene: Emitted test-event');

                await new Promise(r => this.time.delayedCall(500, r));

                // ========================================
                // Test 1B: EventBus –∏–∑ LoadingScene
                // ========================================
                console.log('--- Test 1B: EventBus from LoadingScene ---');

                EventBus.emit('mainScene-test', { from: 'MainScene', phase: 'create()' });
                console.log('üü¢ TestMainScene: Emitted mainScene-test');

                await new Promise(r => this.time.delayedCall(500, r));

                // ========================================
                // –ò–º–∏—Ç–∞—Ü–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Å progress
                // ========================================
                console.log('--- MainScene Initialization ---');

                const loadingScene = this.scene.get('TestLoadingScene');
                console.log('üü¢ TestMainScene: LoadingScene accessible?', !!loadingScene);

                // Test 2: Direct access vs EventBus
                console.log('--- Test 2: Direct vs EventBus ---');

                // 2A: –ü—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø
                if (loadingScene) {
                    console.log('üü¢ TestMainScene: Trying direct call to setProgress()...');
                    try {
                        loadingScene.setProgress(50, 'Direct call 50%');
                        console.log('üü¢ TestMainScene: Direct call SUCCESS ‚úÖ');
                    } catch (e) {
                        console.error('üü¢ TestMainScene: Direct call FAILED ‚ùå', e);
                    }
                }

                await new Promise(r => this.time.delayedCall(500, r));

                // 2B: –ß–µ—Ä–µ–∑ EventBus
                console.log('üü¢ TestMainScene: Trying EventBus...');
                EventBus.emit('loading-progress', { percent: 55, text: 'EventBus 55%' });
                console.log('üü¢ TestMainScene: EventBus emitted');

                // ========================================
                // Test 3: pause() –¥–ª—è LoadingScene
                // ========================================
                console.log('--- Test 3: pause() LoadingScene ---');

                await new Promise(r => this.time.delayedCall(500, r));

                console.log('üü¢ TestMainScene: Pausing LoadingScene...');
                EventBus.emit('pause-loading');
                console.log('üü¢ TestMainScene: LoadingScene paused');

                await new Promise(r => this.time.delayedCall(1000, r));

                console.log('üü¢ TestMainScene: Resuming LoadingScene...');
                EventBus.emit('resume-loading');
                console.log('üü¢ TestMainScene: LoadingScene resumed');

                // ========================================
                // Test 4: Timing finishLoading()
                // ========================================
                console.log('--- Test 4: Timing finishLoading() ---');

                await new Promise(r => this.time.delayedCall(500, r));

                this.isReady = true;
                console.log('üü¢ TestMainScene: Initialization complete, isReady=true');

                // Test 4A: finishLoading() —Å—Ä–∞–∑—É
                console.log('üü¢ TestMainScene: Calling finishLoading() immediately...');
                EventBus.emit('finish-loading');

                await new Promise(r => this.time.delayedCall(500, r));

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
                console.log('üü¢ TestMainScene: create() END');
                console.log('üü¢ TestMainScene: Active scenes after finish:',
                    this.scene.manager.scenes.map(s => s.sceneKey));
            }

            update(time, delta) {
                if (!this.updateCount) this.updateCount = 0;
                this.updateCount++;

                // –ü–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ update()
                if (this.updateCount <= 5) {
                    console.log(`üü¢ TestMainScene: update() #${this.updateCount}, isReady=${this.isReady}`);
                }

                // Test 4B: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–≥–¥–∞ MainScene —Ä–µ–Ω–¥–µ—Ä–∏—Ç –ø–µ—Ä–≤—ã–π —Ä–∞–∑
                if (!this.hasRendered && this.isReady) {
                    console.log(`üü¢ TestMainScene: First update after ready, frame=${this.updateCount}`);
                    this.hasRendered = true;
                }
            }

            delay(ms) {
                return new Promise(resolve => {
                    this.time.delayedCall(ms, resolve);
                });
            }
        }

        // ============================================
        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏–≥—Ä—ã
        // ============================================
        const config = {
            type: Phaser.AUTO,
            width: 800,
            height: 600,
            parent: 'game-container',
            backgroundColor: '#1a202c',
            scene: [TestLoadingScene, TestMainScene],
            physics: {
                default: 'arcade',
                arcade: {
                    gravity: { x: 0, y: 0 }
                }
            }
        };

        // ============================================
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        // ============================================
        console.log('üéÆ Starting game...');
        const game = new Phaser.Game(config);

        // ============================================
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        // ============================================
        function analyzeResults() {
            setTimeout(() => {
                const results = [];

                // –°–æ–±–∏—Ä–∞–µ–º –ª–æ–≥–∏
                const logs = [];
                const originalLog = console.log;
                console.log = (...args) => {
                    logs.push(args.join(' '));
                    originalLog(...args);
                };

                // –ß–µ—Ä–µ–∑ 10 —Å–µ–∫—É–Ω–¥ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º
                setTimeout(() => {
                    console.log = originalLog;

                    // –ê–Ω–∞–ª–∏–∑
                    const hasEventBusBetweenScenes = logs.some(l => l.includes('Received progress event'));
                    const hasGlobalEventBus = logs.some(l => l.includes('EventBus: Emitting'));
                    const hasPauseResume = logs.some(l => l.includes('Paused') || l.includes('Resumed'));
                    const hasDirectAccess = logs.some(l => l.includes('Direct call'));

                    const resultsDiv = document.getElementById('results');
                    resultsDiv.innerHTML = `
                        <h2>üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∞</h2>
                        <div class="result ${hasEventBusBetweenScenes ? '‚úÖ' : '‚ùå'}">
                            Test 1: this.events –º–µ–∂–¥—É —Å—Ü–µ–Ω–∞–º–∏: ${hasEventBusBetweenScenes ? '‚úÖ WORKS' : '‚ùå FAIL'}
                        </div>
                        <div class="result ${hasGlobalEventBus ? '‚úÖ' : '‚ùå'}">
                            Test 2: –ì–ª–æ–±–∞–ª—å–Ω—ã–π EventBus: ${hasGlobalEventBus ? '‚úÖ WORKS' : '‚ùå FAIL'}
                        </div>
                        <div class="result ${hasPauseResume ? '‚úÖ' : '‚ùå'}">
                            Test 3: pause() —Ä–∞–±–æ—Ç–∞–µ—Ç: ${hasPauseResume ? '‚úÖ WORKS' : '‚ùå FAIL'}
                        </div>
                        <div class="result ${hasDirectAccess ? '‚úÖ' : '‚ùå'}">
                            Direct setProgress: ${hasDirectAccess ? '‚úÖ WORKS' : '‚ùå FAIL'}
                        </div>
                        <pre>
                            –õ–æ–≥–∏ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å—Ç—Ä–æ–∫):
                            ${logs.slice(-50).join('\n')}
                        </pre>
                    `;
                }, 10000);
            }, 1000);
        }

        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–Ω–∞–ª–∏–∑
        analyzeResults();
    </script>
</body>
</html>
